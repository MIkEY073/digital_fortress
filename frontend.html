<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Security Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  *{box-sizing:border-box;font-family:Inter,system-ui,"Segoe UI",sans-serif;}

  body{
    margin:0;
    background:#e5e7eb;
    color:#0f1724;
  }

  .hidden{display:none !important;}

  /* ============= LOGIN VIEW ============= */

  #loginView{
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
  }

  #loginView .card {
    width: 400px;
    background: #fff;
    padding: 28px;
    border-radius: 18px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.15);
  }

  #loginView .tabs {
    display: flex;
    gap: 8px;
    background: #f3f4f6;
    padding: 5px;
    border-radius: 999px;
    justify-content: center;
    margin-bottom: 20px;
  }

  #loginView .tab {
    padding: 8px 18px;
    border-radius: 999px;
    background: transparent;
    border: none;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    color: #6b7280;
  }

  #loginView .tab.active {
    background: #fff;
    box-shadow: 0 0 0 1px #d1d5db;
    color: #111827;
  }

  #loginView .title {
    text-align: center;
    font-size: 22px;
    font-weight: 700;
    margin: 0;
  }

  #loginView .subtitle {
    text-align: center;
    font-size: 14px;
    color: #6b7280;
    margin: 6px 0 20px;
  }

  #loginView label {
    display: block;
    margin-top: 12px;
    font-size: 13px;
    font-weight: 500;
    color: #374151;
  }

  #loginView .input-field {
    width: 100%;
    padding: 11px 14px;
    margin-top: 6px;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    background-color: #f9fafb;
    font-size: 14px;
  }

  #loginView .primary-btn {
    width: 100%;
    margin-top: 20px;
    padding: 12px;
    border-radius: 999px;
    border: none;
    background: #16a34a;
    color: white;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
  }

  #loginView .msg{margin-top:10px;text-align:center;font-size:13px;}

  /* ============= DASHBOARD VIEW ============= */

  #dashboardView{
    display:flex;
    gap:28px;
    padding:28px;
    min-height:100vh;
  }

  :root{
    --bg:#f3f6f8;
    --sidebar:#354455;
    --accent:#ff7a2d;
    --muted:#667085;
    --card:#fff;
    --glass: rgba(255,255,255,0.6);
    --radius:14px;
    --shadow: 0 6px 20px rgba(28,39,54,0.08);
    --pill-height:12px;
  }

  .sidebar{
    width:260px; background:var(--sidebar); color:#fff;
    border-radius:12px; padding:28px; flex-shrink:0;
    display:flex; flex-direction:column; justify-content:space-between;
    box-shadow:var(--shadow);
  }
  .brand{display:flex; gap:12px; align-items:center}
  .avatar{
    width:56px;height:56px;border-radius:50%;
    background:#e6eefc;color:#1549a5;display:flex;align-items:center;justify-content:center;
    font-weight:700;font-size:18px;
  }
  .brand h2{font-size:18px; margin:0}

  .menu{margin-top:28px}
  .menu a{
    display:block;
    color:rgba(255,255,255,0.92);
    text-decoration:none;
    padding:10px 0;
    font-weight:600;
    font-size:16px;
    cursor:pointer;
  }
  .menu a:hover{color:#fff;}

  .main{flex:1; display:flex; flex-direction:column;}
  header{
    display:flex; align-items:flex-end; justify-content:space-between; gap:20px;
    margin-bottom:18px;
  }
  header h1{font-size:26px; margin:0}
  .subtitle{color:var(--muted); font-size:14px}

  .content{
    display:grid; grid-template-columns: 1fr 360px; gap:24px; align-items:start;
  }

  .panel{
    background:var(--card); border-radius:var(--radius); padding:18px;
    box-shadow:var(--shadow);
  }
  .panel .section-title{font-size:18px; font-weight:700; margin-bottom:12px}
  .accounts{display:flex; flex-direction:column; gap:14px}

  .account{
    border-radius:12px; padding:14px; background:linear-gradient(180deg, rgba(250,252,255,1), rgba(244,248,250,1));
    border:1px solid rgba(15,23,36,0.04);
    display:flex; gap:14px; align-items:center; justify-content:space-between;
  }

  .acct-left{flex:1;}
  .acct-left h3{
    margin:0;
    font-size:22px;
    font-weight:700;
  }

  .service-link{
    color:#0f172a;
    font-weight:700;
    text-decoration:none;
  }
  .service-link:hover{text-decoration:underline}

  .acct-left small {display:block;color:var(--muted); margin-top:6px}

  .strength{
    margin-top:12px; display:flex; align-items:center; gap:12px;
  }
  .bar{
    width:100%; height:var(--pill-height); background:#e6eef6; border-radius:999px; overflow:hidden; position:relative;
  }
  .bar > i{
    position:absolute; left:0; top:0; bottom:0; width:0%; border-radius:999px;
    transition: width 900ms cubic-bezier(.22,.9,.34,1), background 300ms;
    box-shadow:inset 0 -2px 6px rgba(0,0,0,0.06);
  }
  .meta{font-size:13px;color:var(--muted); margin-top:8px}

  .attr-row{
    font-size:13px;color:var(--muted); margin-top:6px;
    display:flex; gap:8px; align-items:center;
  }
  .attr-label{font-weight:600; color:#0b1220}

  .password-row{
    display:flex; gap:8px; align-items:center; margin-top:8px;
    flex-wrap:wrap;
  }
  .pw-mask{
    font-family:monospace; letter-spacing:2px;
  }

  .acct-actions{display:flex; flex-direction:column; gap:8px; align-items:flex-end}
  .btn-fix{
    background:#f0f6ff;
    border:1px solid rgba(21,73,165,0.2);
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
    font-weight:700;
    color:#1549a5;
    text-decoration:none;
    display:inline-block;
  }

  .btn-toggle{
    background:transparent;
    border:1px solid rgba(15,23,36,0.06);
    padding:6px 8px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    font-size:13px;
  }

  .btn-small{
    padding:6px 8px;
    border-radius:8px;
    background:#fff;
    border:1px solid rgba(15,23,36,0.06);
    cursor:pointer;
    font-size:13px;
  }

  .add-form{
    display:none;
    margin-top:12px;
    padding:12px;
    border-radius:10px;
    border:1px solid rgba(15,23,36,0.04);
    background:#fbfdff;
  }
  .add-form input{
    width:100%; padding:8px; margin-top:8px;
    border-radius:8px; border:1px solid rgba(15,23,36,0.06);
  }
  .add-form .row{
    display:flex; gap:8px;
  }

  .score-card{
    padding:22px; border-radius:var(--radius); background:linear-gradient(180deg,#fff,#fbfdff);
    box-shadow:var(--shadow); text-align:center;
  }
  .donut-wrap{display:flex; align-items:center; justify-content:center; margin-bottom:10px}
  .score-number{font-weight:800; font-size:34px; margin-top:10px}
  .score-label{color:var(--muted); font-size:13px; margin-bottom:12px}

  .legend{display:flex; flex-direction:column; gap:8px; text-align:left; margin-top:12px; font-size:14px}
  .legend .row{display:flex; gap:10px; align-items:center}
  .dot{width:12px;height:12px;border-radius:3px;display:inline-block}

  .modal-backdrop{
    position:fixed; inset:0;
    display:none;
    align-items:center; justify-content:center;
    background:rgba(11,18,32,0.45); z-index:60;
  }
  .modal{
    background:#fff; padding:18px; border-radius:10px;
    box-shadow:0 10px 30px rgba(2,6,23,0.2);
    width:360px; max-width:90%;
  }
  .modal h3{ margin:0 0 8px 0 }
  .modal p{ margin:0 0 12px 0; color:var(--muted) }
  .modal .controls{ display:flex; gap:8px; justify-content:flex-end }

  @media (max-width:980px){
    #dashboardView{padding:16px}
    .content{grid-template-columns: 1fr; }
    .score-card{order:-1}
    .sidebar{display:none}
  }

  /* ============= OTHER VIEWS (web/breach/file/guide/account) ============= */

  .back-btn {
    display: inline-block;
    margin: 20px;
    padding: 10px 16px;
    background: #ffffff;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    text-decoration: none;
    color: #1f2937;
    font-weight: 500;
    font-size: 0.95rem;
    transition: 0.2s;
    cursor:pointer;
  }
  .back-btn:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
  }

  .page-container {
    max-width: 960px;
    margin: 0 auto 32px;
    background: #ffffff;
    border-radius: 16px;
    padding: 24px 28px 28px;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
    border: 1px solid #e5e7eb;
  }

  .page-container h1 {
    margin-top: 0;
    font-size: 1.7rem;
    font-weight: 750;
  }

  .page-container p, .page-container li {
    line-height: 1.6;
    color: #4b5563;
  }

  .page-container label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 6px;
    color: #374151;
  }

  .page-input {
    width: 100%;
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    background: #f9fafb;
    font-size: 0.95rem;
    margin-bottom: 10px;
  }

  .page-btn {
    padding: 9px 18px;
    border-radius: 999px;
    border: none;
    background: #0e71c8;
    color: white;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
  }

  .page-btn:disabled {
    opacity: 0.7;
    cursor: default;
  }

  .status { margin-top:10px; font-size:0.9rem;}
  .status.safe,.status.good {color:#15803d;}
  .status.danger,.status.bad {color:#b91c1c;}

  .section-border {
    margin-top: 18px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }
  th, td {
    padding: 6px 8px;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
  }
  th {
    background: #f9fafb;
    font-weight: 600;
  }

  .tag-danger, .tag-breached, .tag-malicious {
    display:inline-block;padding:2px 8px;border-radius:999px;
    background:#fee2e2;color:#b91c1c;font-size:0.75rem;font-weight:600;
  }
  .tag-safe, .tag-clean {
    display:inline-block;padding:2px 8px;border-radius:999px;
    background:#dcfce7;color:#166534;font-size:0.75rem;font-weight:600;
  }

  .file-row {margin-top:10px;margin-bottom:10px;}

  .tagline {
    color: #6b7280;
    font-size: 0.95rem;
    margin-top: -6px;
    margin-bottom: 22px;
  }

  .example-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
    gap: 16px;
  }

  .guide-card {
    background: #f9fafb;
    border-radius: 12px;
    padding: 14px 16px;
    border: 1px solid #e5e7eb;
  }

  .badge {
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 6px;
  }

  .badge-weak {background:#fee2e2;color:#b91c1c;}
  .badge-ok {background:#fef3c7;color:#92400e;}
  .badge-strong {background:#dcfce7;color:#166534;}
  .tip-list li {margin-bottom:6px;}
  .highlight {color:#15803d;font-weight:600;}

  /* ============= ACCOUNT VIEW ============= */

  #accountView{
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    padding:26px;
  }

  #accountView .card{
    width:100%;
    max-width:420px;
    background:#ffffff;
    padding:32px;
    border-radius:14px;
    box-shadow:0 8px 28px rgba(0,0,0,0.08);
    position:relative;
  }

  #accountView .back{
    position:absolute;
    top:16px;
    left:16px;
    background:#f0f3f8;
    padding:8px 12px;
    border-radius:10px;
    text-decoration:none;
    color:#333;
    font-size:13px;
    border:1px solid #e1e4ea;
    display:inline-flex;
    align-items:center;
    gap:6px;
    cursor:pointer;
  }

  #accountView .title{
    text-align:center;
    font-size:28px;
    font-weight:700;
    color:#152a46;
    margin-bottom:30px;
  }

  #accountView label{
    display:block;
    margin-bottom:6px;
    font-size:14px;
    color:#6b7280;
  }

  #accountView input{
    width:100%;
    padding:12px 14px;
    border-radius:10px;
    border:1px solid #e2e5ec;
    font-size:15px;
    margin-bottom:18px;
  }

  #accountView input:focus{
    border-color:#0e71c8;
    outline:none;
    box-shadow:0 0 6px rgba(14,113,200,0.3);
  }

  #accountView .btn-primary{
    width:100%;
    background:#152a46;
    color:white;
    padding:12px 14px;
    border:none;
    border-radius:10px;
    font-size:16px;
    cursor:pointer;
  }

  /* ============= CHANGE PASSWORD VIEW ============= */

  #changePwView{
    margin:0;
    background:#e6e9ef;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  #changePwView .card{
    width: 700px;
    background: #fff;
    padding: 35px 45px;
    border-radius: 18px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.10);
    position: relative;
  }

  #changePwView .back-btn {
    position: absolute;
    left: 20px;
    top: 20px;
    background: #eef2ff;
    padding: 8px 18px;
    border-radius: 20px;
    font-size: 13px;
    border: 1px solid #6366f1;
    cursor: pointer;
    font-weight: 600;
    color: #3730a3;
    text-decoration: none;
  }

  #changePwView h2 {
    text-align: center;
    font-size: 22px;
    font-weight: 700;
    margin: 0;
  }

  #changePwView .wrapper {
    display: flex;
    justify-content: space-between;
    gap: 25px;
    margin-top: 20px;
  }

  #changePwView table { width: 60%; }
  #changePwView td { padding: 10px 0; }

  #changePwView label {
    font-size: 13px;
    font-weight: 600;
    color: #374151;
  }

  #changePwView .password-wrapper { position: relative; width: 100%; }

  #changePwView .toggle-btn {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 11px;
    cursor: pointer;
    color: #4f46e5;
    font-weight: 600;
  }

  #changePwView input[type="password"], 
  #changePwView input[type="text"] {
    width: 100%;
    padding: 12px 40px 12px 15px;
    border-radius: 30px;
    border: 1px solid #d1d5db;
    background: #f3f4f6;
    font-size: 14px;
  }

  #changePwView .suggest-block {
    background: #f9fafb;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid #d1d5db;
    margin-top: 12px;
  }

  #changePwView .suggested-text-box {
    margin-top: 8px;
    padding: 10px;
    background: #fff;
    border-radius: 10px;
    border: 1px solid #d1d5db;
    font-size: 13px;
    word-break: break-all;
    text-align: center;
    font-weight: 600;
    color: #111827;
    display: none;
  }

  #changePwView .suggest-btn,
  #changePwView .copy-btn {
    width: 100%;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 6px;
  }

  #changePwView .suggest-btn {
    background: #eef2ff;
    border: 1px solid #6366f1;
    color: #3730a3;
  }

  #changePwView .copy-btn {
    background: #d1fae5;
    border: 1px solid #10b981;
    color: #065f46;
  }

  #changePwView .copy-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  #changePwView .strength-box {
    width: 40%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #changePwView .circle {
    width: 140px;
    height: 140px;
    border-radius: 50%;
    background: conic-gradient(#ff6b6b 0deg, #e5e7eb 0deg);
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  #changePwView .circle::after {
    content: "";
    position: absolute;
    inset: 12px;
    background: #fff;
    border-radius: 50%;
    z-index: 1;
  }

  #changePwView .circle-value {
    position: relative;
    z-index: 2;
    font-size: 22px;
    font-weight: 700;
    text-align: center;
  }

  #changePwView .circle-value span {
    display: block;
    font-size: 13px;
    margin-top: 3px;
    color: #6b7280;
  }

  #changePwView .submit-btn {
    width: 100%;
    margin-top: 25px;
    background: #16a34a;
    border: none;
    padding: 14px;
    border-radius: 30px;
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
  }
</style>
</head>
<body>

<!-- LOGIN VIEW -->
<div id="loginView">
  <div class="card">
    <div class="tabs">
      <button class="tab active" id="loginTab">Login</button>
      <button class="tab" id="signupTab">Create Account</button>
    </div>

    <h1 class="title" id="formTitle">Login</h1>
    <p class="subtitle" id="formSubtitle">Access your secure dashboard</p>

    <form id="loginForm">
      <label>Email address</label>
      <input id="loginEmail" class="input-field" type="email" placeholder="example@gmail.com" required>

      <label>Password</label>
      <input id="loginPassword" class="input-field" type="password" placeholder="Enter password" required>

      <button class="primary-btn" type="submit">Login</button>
      <div id="loginMsg" class="msg"></div>
    </form>

    <form id="signupForm" class="hidden">
      <label>Full name</label>
      <input id="signupName" class="input-field" type="text" placeholder="Your full name" required>

      <label>Email address</label>
      <input id="signupEmail" class="input-field" type="email" placeholder="example@gmail.com" required>

      <label>Password</label>
      <input id="signupPassword" class="input-field" type="password" placeholder="Create a strong password" required>

      <button class="primary-btn" type="submit">Create Account</button>
      <div id="signupMsg" class="msg"></div>
    </form>
  </div>
</div>

<!-- DASHBOARD VIEW -->
<div id="dashboardView" class="hidden">
  <aside class="sidebar">
    <div>
      <div class="brand">
        <div class="avatar">SD</div>
        <div>
          <h2>Security Dashboard</h2>
          <div style="color:rgba(255,255,255,0.85); font-size:13px" id="userLabel">User</div>
        </div>
      </div>

      <nav class="menu">
        <a data-nav="dashboard">Dashboard</a>
        <a data-nav="web">Web Safety Check</a>
        <a data-nav="breach">Mail Breach</a>
        <a data-nav="file">File Scan</a>
        <a data-nav="guide">Guide</a>
      </nav>
    </div>

    <div></div>
  </aside>

  <main class="main">
    <header>
      <div>
        <h1>Security Dashboard — Passwords & Score</h1>
        <div class="subtitle">Review account passwords and recommended fixes</div>
      </div>
    </header>

    <section class="content">
      <div class="panel">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <div class="section-title">Passwords (click Change Password to open page)</div>
          <button id="btnAdd" class="btn-small" type="button">Add Account</button>
        </div>

        <div class="add-form" id="addForm">
          <div>
            <label>Platform name</label>
            <input id="newName" placeholder="e.g. LinkedIn">
          </div>
          <div>
            <label>Username / email</label>
            <input id="newUser" placeholder="username or email">
          </div>
          <div>
            <label>Password</label>
            <input id="newPassword" placeholder="password">
          </div>
          <div class="row" style="margin-top:8px">
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="new2fa"> Two-factor
            </label>
          </div>
          <div style="display:flex; gap:8px; margin-top:10px">
            <button id="saveAdd" class="btn-small" type="button">Save</button>
            <button id="cancelAdd" class="btn-small" type="button">Cancel</button>
          </div>
          <div style="margin-top:8px; font-size:13px; color:var(--muted)">
            Password strength will be determined automatically based on the entered password.
          </div>
        </div>

        <div class="accounts" id="accounts"></div>
      </div>

      <aside class="score-card">
        <div class="section-title" style="font-size:18px">Overall Security Score</div>

        <div class="donut-wrap">
          <svg id="donut" width="160" height="160" viewBox="0 0 160 160">
            <circle cx="80" cy="80" r="60" fill="none" stroke="#eef2f6" stroke-width="18"/>
            <circle id="arc" cx="80" cy="80" r="60" fill="none" stroke="#f59e0b" stroke-width="18"
              stroke-linecap="round" transform="rotate(-90 80 80)"
              stroke-dasharray="377" stroke-dashoffset="377"></circle>
            <text id="scoreText" x="80" y="88" text-anchor="middle"
              font-size="28" font-weight="700" fill="#0b1220">0%</text>
          </svg>
        </div>

        <div class="score-number" id="scoreNumber">0%</div>
        <div class="score-label">Tip: prioritize accounts marked "Compromised" first.</div>

        <div class="legend">
          <div class="row"><span class="dot" style="background:#16a34a"></span>90–100 — Excellent</div>
          <div class="row"><span class="dot" style="background:#0ea5e9"></span>80–89 — Good</div>
          <div class="row"><span class="dot" style="background:#f59e0b"></span>60–79 — OK</div>
          <div class="row"><span class="dot" style="background:#f97316"></span>40–59 — Bad</div>
          <div class="row"><span class="dot" style="background:#ef4444"></span>0–39 — Change your passwords</div>
        </div>
      </aside>
    </section>
  </main>
</div>

<!-- DELETE MODAL -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Delete account</h3>
    <p id="modalMessage">Are you sure you want to delete this account? This cannot be undone.</p>
    <div class="controls">
      <button id="cancelDelete" class="btn-small" type="button">Cancel</button>
      <button id="confirmDelete" class="btn-small" type="button" style="background:#ef4444;color:#fff;border-color:transparent">Delete</button>
    </div>
  </div>
</div>

<!-- WEB VIEW -->
<div id="webView" class="hidden">
  <button class="back-btn" data-back="dashboard">← Back</button>
  <div class="page-container">
    <h1>Web Safety Check</h1>
    <p>Enter a website URL to see if it looks risky (phishing, no HTTPS, risky TLD, etc.).</p>

    <label for="urlInput">Website URL</label>
    <input id="urlInput" type="text" class="page-input" placeholder="https://example.com">

    <button id="webCheckBtn" class="page-btn" type="button">Check Website</button>
    <div id="webStatus" class="status"></div>

    <div id="webReasonsBox" style="margin-top:8px;display:none;">
      <strong>Details:</strong>
      <ul id="webReasonsList"></ul>
    </div>

    <div class="section-border">
      <div style="font-weight:600;margin-bottom:6px;">Recent checks (this browser only)</div>
      <div id="webHistoryEmpty" style="font-size:0.85rem;color:#6b7280;">No history yet.</div>
      <table id="webHistoryTable" style="display:none;">
        <thead>
          <tr><th>URL</th><th>Result</th><th>Time</th></tr>
        </thead>
        <tbody id="webHistoryBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- BREACH VIEW -->
<div id="breachView" class="hidden">
  <button class="back-btn" data-back="dashboard">← Back</button>
  <div class="page-container">
    <h1>Email Breach Check</h1>
    <p>Check if your email address has been found in known data breaches (XposedOrNot).</p>

    <label for="breachEmailInput">Email address</label>
    <input id="breachEmailInput" type="email" class="page-input" placeholder="you@example.com">

    <button id="breachCheckBtn" class="page-btn" type="button">Check Breach Status</button>
    <div id="breachStatusMsg" class="status"></div>

    <div class="section-border">
      <div style="font-weight:600;margin-bottom:6px;">Recent email checks (this browser only)</div>
      <div id="breachHistoryEmpty" style="font-size:0.85rem;color:#6b7280;">No history yet.</div>

      <table id="breachHistoryTable" style="display:none;">
        <thead>
          <tr><th>Email</th><th>Status</th><th>Breaches</th><th>Time</th></tr>
        </thead>
        <tbody id="breachHistoryBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- FILE VIEW -->
<div id="fileView" class="hidden">
  <button class="back-btn" data-back="dashboard">← Back</button>
  <div class="page-container">
    <h1>File Malware Scan</h1>
    <p>Upload a file to scan with VirusTotal (multiple antivirus engines).</p>

    <div class="file-row">
      <input id="fileInput" type="file" />
    </div>

    <button id="scanBtn" class="page-btn" type="button">Scan File</button>
    <div id="fileStatusMsg" class="status"></div>

    <div id="threatBox" style="margin-top:8px;display:none;">
      <strong>Detected threats:</strong>
      <ul id="threatList"></ul>
    </div>

    <div class="section-border">
      <div style="font-weight:600;margin-bottom:6px;">Recent scans (this browser only)</div>
      <div id="fileHistoryEmpty" style="font-size:0.85rem;color:#6b7280;">No scans yet.</div>

      <table id="fileHistoryTable" style="display:none;">
        <thead>
          <tr><th>File name</th><th>Result</th><th>Detections</th><th>Engines</th><th>Time</th></tr>
        </thead>
        <tbody id="fileHistoryBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- GUIDE VIEW -->
<div id="guideView" class="hidden">
  <button class="back-btn" data-back="dashboard">← Back</button>
  <div class="page-container">
    <h1>Password Strength & Safety Guide</h1>
    <p class="tagline">A quick dashboard-style guide to understand password strength and learn how to create safer passwords.</p>

    <div class="section-border" style="border-top:none;margin-top:0;">
      <h2>1. What is Password Strength?</h2>
      <p><strong>Password strength</strong> means how hard it is for someone (or a computer) to guess or crack your password.</p>
      <ul>
        <li><strong>Length</strong> – more characters = harder to crack.</li>
        <li><strong>Complexity</strong> – mix of letters, numbers and symbols.</li>
        <li><strong>Unpredictability</strong> – not based on your personal info.</li>
        <li><strong>Uniqueness</strong> – different passwords for different accounts.</li>
      </ul>
    </div>

    <div class="section-border">
      <h2>2. Weak vs Strong Password Examples</h2>
      <div class="example-grid">
        <div class="guide-card">
          <h3>❌ Weak Passwords <span class="badge badge-weak">Weak</span></h3>
          <ul>
            <li><code>123456</code></li>
            <li><code>password</code></li>
            <li><code>qwerty</code></li>
            <li><code>myname123</code></li>
          </ul>
        </div>
        <div class="guide-card">
          <h3>⚠️ Okay Passwords <span class="badge badge-ok">Medium</span></h3>
          <ul>
            <li><code>Ravi@2004</code></li>
            <li><code>Football#19</code></li>
          </ul>
        </div>
        <div class="guide-card">
          <h3>✅ Strong Passwords <span class="badge badge-strong">Strong</span></h3>
          <ul>
            <li><code>mango!Sky7_bridge</code></li>
            <li><code>Sunrise#92!blueTrain</code></li>
            <li><code>3Cows&2Moons-run</code></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="section-border">
      <h2>3. Tips to Create Strong Passwords</h2>
      <ul class="tip-list">
        <li><span class="highlight">Use at least 12–16 characters.</span></li>
        <li>Mix uppercase, lowercase, numbers & symbols.</li>
        <li>Do NOT use personal info (name, DOB, pets).</li>
        <li>Avoid common words like <code>password</code>, <code>admin</code>.</li>
        <li>Create passphrases:
          <br><code>Red!Tiger_eats3Cookies</code>
        </li>
        <li>Use different passwords for major accounts.</li>
        <li>Consider a password manager.</li>
        <li>Enable 2FA / OTP whenever possible.</li>
      </ul>
    </div>

    <div class="section-border">
      <h2>4. Quick Checklist</h2>
      <ul style="list-style:none;padding-left:0;margin-left:0;">
        <li>● 12+ characters?</li>
        <li>● Mixed characters (Aa, 0-9, symbols)?</li>
        <li>● No personal information?</li>
        <li>● Different from other accounts?</li>
      </ul>
    </div>
  </div>
</div>

<!-- ACCOUNT VIEW -->
<div id="accountView" class="hidden">
  <div class="card">
    <a class="back" data-back="dashboard">← Back</a>
    <div class="title" id="serviceTitle">Account</div>

    <label>Email / Username</label>
    <input type="text" placeholder="Enter your email or username">

    <label>Password</label>
    <input type="password" placeholder="Enter your password">

    <button class="btn-primary" type="button">Log In</button>
  </div>
</div>

<!-- CHANGE PASSWORD VIEW -->
<div id="changePwView" class="hidden">
  <div class="card">
    <button class="back-btn" data-back="dashboard" type="button">← Back</button>
    <h2 id="pageTitle">Password Change</h2>

    <div class="wrapper">
      <table>
        <tr><td><label>New Password</label></td></tr>
        <tr>
          <td>
            <div class="password-wrapper">
              <input type="password" id="newPw">
              <span class="toggle-btn" data-target="newPw">Show</span>
            </div>
          </td>
        </tr>

        <tr><td><label>Re-enter Password</label></td></tr>
        <tr>
          <td>
            <div class="password-wrapper">
              <input type="password" id="rePw">
              <span class="toggle-btn" data-target="rePw">Show</span>
            </div>
          </td>
        </tr>

        <tr>
          <td>
            <div class="suggest-block">
              <button class="suggest-btn" id="suggestBtn" type="button">Suggest Password</button>
              <div id="visibleSuggestion" class="suggested-text-box"></div>
              <button class="copy-btn" id="copyBtn" type="button" disabled>Copy Suggested Password</button>
            </div>
          </td>
        </tr>
      </table>

      <div class="strength-box">
        <div class="circle" id="strengthCircle">
          <div class="circle-value" id="circleValue">
            0
            <span>/ 100</span>
          </div>
        </div>
      </div>
    </div>

    <button class="submit-btn" id="savePwBtn" type="button">Password Change</button>
  </div>
</div>

<script>
  const API = "http://localhost:8000";
  let LOGGED_USER_ID = null;
  let CURRENT_SERVICE = null;

  /* VIEW NAVIGATION */
  const views = {
    login: document.getElementById("loginView"),
    dashboard: document.getElementById("dashboardView"),
    web: document.getElementById("webView"),
    breach: document.getElementById("breachView"),
    file: document.getElementById("fileView"),
    guide: document.getElementById("guideView"),
    account: document.getElementById("accountView"),
    changePw: document.getElementById("changePwView"),
  };

  function showView(name){
    Object.values(views).forEach(v => v.classList.add("hidden"));
    views[name].classList.remove("hidden");
  }

  document.querySelectorAll("[data-back]").forEach(el => {
    el.addEventListener("click", () => showView(el.dataset.back));
  });

  document.querySelectorAll(".menu a[data-nav]").forEach(a => {
    a.addEventListener("click", () => showView(a.dataset.nav));
  });

  /* LOGIN / SIGNUP */
  const loginTab = document.getElementById("loginTab");
  const signupTab = document.getElementById("signupTab");
  const loginForm = document.getElementById("loginForm");
  const signupForm = document.getElementById("signupForm");
  const formTitle = document.getElementById("formTitle");
  const formSubtitle = document.getElementById("formSubtitle");
  const loginMsg = document.getElementById("loginMsg");
  const signupMsg = document.getElementById("signupMsg");
  const userLabel = document.getElementById("userLabel");

  loginTab.onclick = () => {
    loginTab.classList.add("active");
    signupTab.classList.remove("active");
    loginForm.classList.remove("hidden");
    signupForm.classList.add("hidden");
    formTitle.textContent = "Login";
    formSubtitle.textContent = "Access your secure dashboard";
    loginMsg.textContent = "";
    signupMsg.textContent = "";
  };

  signupTab.onclick = () => {
    signupTab.classList.add("active");
    loginTab.classList.remove("active");
    signupForm.classList.remove("hidden");
    loginForm.classList.add("hidden");
    formTitle.textContent = "Create Account";
    formSubtitle.textContent = "Register to secure your account";
    loginMsg.textContent = "";
    signupMsg.textContent = "";
  };

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;

    loginMsg.textContent = "Logging in...";
    loginMsg.style.color = "#111827";

    try {
      const res = await fetch(`${API}/api/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();
      if (!res.ok) {
        loginMsg.textContent = data.detail || "Login failed";
        loginMsg.style.color = "red";
        return;
      }
      LOGGED_USER_ID = data.user_id;
      loginMsg.textContent = data.message;
      loginMsg.style.color = "green";
      userLabel.textContent = email;
      showView("dashboard");
    } catch (err) {
      console.error(err);
      loginMsg.textContent = "Network error.";
      loginMsg.style.color = "red";
    }
  });

  signupForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("signupName").value.trim();
    const email = document.getElementById("signupEmail").value.trim();
    const password = document.getElementById("signupPassword").value;

    signupMsg.textContent = "Creating account...";
    signupMsg.style.color = "#111827";

    try {
      const res = await fetch(`${API}/api/signup`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email, password })
      });
      const data = await res.json();
      if (!res.ok) {
        signupMsg.textContent = data.detail || "Signup failed";
        signupMsg.style.color = "red";
        return;
      }
      signupMsg.textContent = data.message || "Account created!";
      signupMsg.style.color = "green";
    } catch (err) {
      console.error(err);
      signupMsg.textContent = "Network error.";
      signupMsg.style.color = "red";
    }
  });

  /* DASHBOARD ACCOUNTS (localStorage + DB sync) */
  (function(){
    const STORAGE_KEY = 'securityDashboardAccounts';

    const defaultAccounts = [
      { id: 'google',    name:'Google',    user:'user@gmail.com', strength:92, last:'2024-10-01', compromised:false, twoFactor:true,  password:'*******' },
      { id: 'instagram', name:'Instagram', user:'insta_user',     strength:64, last:'2023-11-12', compromised:false, twoFactor:false, password:'*******' },
      { id: 'facebook',  name:'Facebook',  user:'fb_user',        strength:38, last:'2021-05-03', compromised:true,  twoFactor:false, password:'*******' },
      { id: 'twitter',   name:'Twitter',   user:'@user',          strength:55, last:'2022-08-20', compromised:false, twoFactor:true,  password:'*******' },
    ];

    function loadAccounts(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return defaultAccounts.map(a => ({...a}));
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)) return parsed;
        return defaultAccounts.map(a => ({...a}));
      }catch(e){
        return defaultAccounts.map(a => ({...a}));
      }
    }

    function saveAccounts(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(accountsData));
      }catch(e){}
    }

    let accountsData = loadAccounts();

    const accountsContainer = document.getElementById('accounts');
    const donutArc = document.getElementById('arc');
    const scoreText = document.getElementById('scoreText');
    const scoreNumber = document.getElementById('scoreNumber');

    const btnAdd = document.getElementById('btnAdd');
    const addForm = document.getElementById('addForm');
    const newName = document.getElementById('newName');
    const newUser = document.getElementById('newUser');
    const newPassword = document.getElementById('newPassword');
    const new2fa = document.getElementById('new2fa');
    const saveAdd = document.getElementById('saveAdd');
    const cancelAdd = document.getElementById('cancelAdd');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const confirmDelete = document.getElementById('confirmDelete');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    let pendingDeleteId = null;

    function colorForScore(n){
      if(n >= 90) return '#16a34a';
      if(n >= 80) return '#0ea5e9';
      if(n >= 60) return '#f59e0b';
      if(n >= 40) return '#f97316';
      return '#ef4444';
    }

    function createEl(tag, props){
      const el = document.createElement(tag);
      if(!props) return el;
      if(props.className) el.className = props.className;
      if(props.text !== undefined) el.textContent = props.text;
      if(props.html !== undefined) el.innerHTML = props.html;
      if(props.attrs) Object.keys(props.attrs).forEach(k => el.setAttribute(k, props.attrs[k]));
      return el;
    }

    function computeStrengthFromPassword(pw){
      if(!pw) return 10;
      let score = 0;
      if(pw.length >= 8)  score += 25;
      if(pw.length >= 12) score += 15;
      if(/[a-z]/.test(pw)) score += 10;
      if(/[A-Z]/.test(pw)) score += 15;
      if(/[0-9]/.test(pw)) score += 15;
      if(/[^A-Za-z0-9]/.test(pw)) score += 20;
      return Math.min(100, Math.max(5, Math.round(score)));
    }

    function computeDisplayStrength(acc){
      return acc.twoFactor ? Math.min(100, acc.strength + 2) : acc.strength;
    }

    function mask(pw){
      if(!pw) return '—';
      return '•'.repeat(8);
    }

    function openDeleteModal(id){
      pendingDeleteId = id;
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden', 'false');
    }
    function closeDeleteModal(){
      pendingDeleteId = null;
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden', 'true');
    }

    function renderAccounts(){
      accountsContainer.innerHTML = '';

      accountsData.forEach(acc => {
        if(typeof acc.strength !== 'number'){
          acc.strength = computeStrengthFromPassword(acc.password);
        }
        const displayStrength = computeDisplayStrength(acc);

        const card = createEl('div', { className: 'account' });
        const left = createEl('div', { className: 'acct-left' });

        const h3 = createEl('h3');
        const nameLink = createEl('a', {
          text: acc.name,
          attrs:{ href:'#', class:'service-link', 'data-service':acc.name }
        });
        h3.appendChild(nameLink);
        left.appendChild(h3);

        const smallHtml = acc.compromised
          ? acc.user + " <span style='color:#ef4444; font-weight:700; margin-left:8px'>• Compromised</span>"
          : acc.user;
        left.appendChild(createEl('small', { html: smallHtml }));

        const strengthWrap = createEl('div', { className: 'strength' });
        const bar = createEl('div', { className: 'bar' });
        bar.setAttribute('role','progressbar');
        bar.setAttribute('aria-valuemin','0');
        bar.setAttribute('aria-valuemax','100');
        bar.setAttribute('aria-valuenow', String(displayStrength));
        const fill = createEl('i');
        fill.style.width = '0%';
        fill.style.background = colorForScore(displayStrength);
        bar.appendChild(fill);
        strengthWrap.appendChild(bar);
        left.appendChild(strengthWrap);

        left.appendChild(createEl('div', {
          className: 'meta',
          text: `Strength: ${displayStrength}% • Last changed: ${acc.last}`
        }));

        const twoFactorRow = createEl('div', { className: 'attr-row' });
        twoFactorRow.appendChild(createEl('span', { className: 'attr-label', text: 'Two-factor:' }));
        twoFactorRow.appendChild(createEl('span', { text: acc.twoFactor ? 'Enabled' : 'Disabled' }));
        left.appendChild(twoFactorRow);

        const pwRow = createEl('div', { className: 'password-row' });
        const pwLabel = createEl('span', { className: 'attr-label', text: 'Password:' });
        const pwVal = createEl('span', { className: 'pw-mask', text: mask(acc.password) });
        const showBtn = createEl('button', { text: 'Show', className: 'btn-small' });
        showBtn.addEventListener('click', () => {
          if(pwVal.textContent === mask(acc.password)){
            pwVal.textContent = acc.password || '—';
            showBtn.textContent = 'Hide';
          } else {
            pwVal.textContent = mask(acc.password);
            showBtn.textContent = 'Show';
          }
        });
        const deleteBtn = createEl('button', { text: 'Delete', className: 'btn-small' });
        deleteBtn.addEventListener('click', () => { openDeleteModal(acc.id); });

        pwRow.appendChild(pwLabel);
        pwRow.appendChild(pwVal);
        pwRow.appendChild(showBtn);
        pwRow.appendChild(deleteBtn);
        left.appendChild(pwRow);

        card.appendChild(left);

        const actions = createEl('div', { className: 'acct-actions' });

        // Change Password link: only opens internal change-password page
        const fix = createEl('a', { text: 'Change Password' });
        fix.className = 'btn-fix';
        fix.setAttribute('href', '#');
        fix.setAttribute('data-service', acc.name);
        actions.appendChild(fix);

        const toggle = createEl('button', {
          text: acc.twoFactor ? 'Disable 2FA' : 'Enable 2FA',
          className: 'btn-toggle',
          attrs:{ 'data-id':acc.id, 'aria-pressed': acc.twoFactor ? 'true' : 'false' }
        });
        actions.appendChild(toggle);

        card.appendChild(actions);
        accountsContainer.appendChild(card);

        requestAnimationFrame(() => { fill.style.width = displayStrength + '%'; });
      });

      document.querySelectorAll('.btn-toggle').forEach(btn => {
        btn.addEventListener('click', evt => {
          const id = evt.currentTarget.getAttribute('data-id');
          toggleTwoFactor(id);
        });
      });

      document.querySelectorAll('.service-link').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          openAccount(a.dataset.service);
        });
      });

      // Now: just open internal change-password
      document.querySelectorAll('.btn-fix').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          openChangePassword(a.dataset.service);
        });
      });

      setTimeout(() => { setDonut(computeOverall()); }, 0);
    }

    async function deleteAccount(id){
      const idx = accountsData.findIndex(a => a.id === id);
      if(idx === -1) return;
      const acc = accountsData[idx];

      if (LOGGED_USER_ID) {
        try {
          const res = await fetch(`${API}/api/delete_credentials`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_id: LOGGED_USER_ID,
              platform: acc.name,
              user_name: acc.user
            })
          });
          const data = await res.json();
          if (!res.ok) {
            console.error("Delete credentials error:", data);
          }
        } catch (err) {
          console.error("Network error deleting credentials", err);
        }
      }

      accountsData.splice(idx,1);
      saveAccounts();
      renderAccounts();
    }

    btnAdd.addEventListener('click', () => {
      const visible = addForm.style.display === 'block';
      addForm.style.display = visible ? 'none' : 'block';
    });

    cancelAdd.addEventListener('click', () => {
      addForm.style.display = 'none';
      clearAddForm();
    });

    saveAdd.addEventListener('click', async () => {
      const name = newName.value.trim();
      const user = newUser.value.trim();
      const pw   = newPassword.value;
      const two  = new2fa.checked;

      if (!name || !user) {
        alert('Platform name and username are required');
        return;
      }

      if (!LOGGED_USER_ID) {
        alert("Please log in again before adding accounts.");
        showView("login");
        return;
      }

      const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '_') + '_' + Date.now().toString(36);
      const strength = computeStrengthFromPassword(pw);

      accountsData.push({
        id,
        name,
        user,
        password: pw,
        strength,
        last: new Date().toISOString().slice(0, 10),
        compromised: false,
        twoFactor: two
      });
      saveAccounts();
      renderAccounts();

      try {
        const res = await fetch(`${API}/api/save_credentials`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: LOGGED_USER_ID,
            user_name: user,
            passw: pw,
            platform: name,
            strength_score: strength
          })
        });

        const data = await res.json();
        if (!res.ok) {
          console.error("Save credentials error:", data);
          alert(data.detail || "Error saving credentials in database.");
        }
      } catch (err) {
        console.error(err);
        alert("Network error while saving credentials to database.");
      }

      clearAddForm();
      addForm.style.display = 'none';
    });

    function clearAddForm(){
      newName.value = '';
      newUser.value = '';
      newPassword.value = '';
      new2fa.checked = false;
    }

    function toggleTwoFactor(id){
      const idx = accountsData.findIndex(a => a.id === id);
      if(idx === -1) return;
      accountsData[idx].twoFactor = !accountsData[idx].twoFactor;
      saveAccounts();
      renderAccounts();
    }

    function computeOverall(){
      if(!accountsData.length) return 0;
      let total = 0;
      accountsData.forEach(a => {
        let s = a.strength;
        if(a.compromised) s = Math.min(s, 35);
        if(a.twoFactor) s = Math.min(100, s + 2);
        total += s;
      });
      return Math.round(total / accountsData.length);
    }

    function setDonut(score){
      if(!donutArc) return;
      const r = 60;
      const circumference = 2 * Math.PI * r;
      donutArc.style.strokeDasharray = String(circumference);
      const offset = circumference * (1 - score / 100);
      donutArc.style.transition = 'stroke-dashoffset 600ms ease';
      donutArc.style.strokeDashoffset = String(offset);
      donutArc.style.stroke = colorForScore(score);
      if(scoreText) scoreText.textContent = score + '%';
      if(scoreNumber) scoreNumber.textContent = score + '%';
    }

    confirmDelete.addEventListener('click', () => {
      if(pendingDeleteId){
        deleteAccount(pendingDeleteId);
      }
      closeDeleteModal();
    });
    cancelDeleteBtn.addEventListener('click', () => { closeDeleteModal(); });
    modalBackdrop.addEventListener('click', (e) => {
      if(e.target === modalBackdrop) closeDeleteModal();
    });

    // helper used from change-password page
    window.updateLocalAccountPassword = function(platformName, newPassword, strength){
      const acc = accountsData.find(a => a.name === platformName);
      if (!acc) return;
      acc.password = newPassword;
      acc.strength = strength;
      acc.last = new Date().toISOString().slice(0,10);
      saveAccounts();
      renderAccounts();
    };

    renderAccounts();
  })();

  /* ACCOUNT VIEW helper */
  function openAccount(service){
    CURRENT_SERVICE = service;
    document.getElementById("serviceTitle").textContent = service + " Account";
    document.title = service + " Account";
    showView("account");
  }

  /* CHANGE PASSWORD VIEW */
  const pageTitleEl = document.getElementById('pageTitle');
  const newPw = document.getElementById("newPw");
  const rePw = document.getElementById("rePw");
  const suggestBtn = document.getElementById("suggestBtn");
  const copyBtn = document.getElementById("copyBtn");
  const visibleSuggestion = document.getElementById("visibleSuggestion");
  const circle = document.getElementById("strengthCircle");
  const circleValue = document.getElementById("circleValue");
  const savePwBtn = document.getElementById("savePwBtn");

  function estimateStrength(pw) {
    if (!pw) return 0;
    let s = 0;
    s += Math.min(40, pw.length * 3);
    if (/[A-Z]/.test(pw)) s += 10;
    if (/[a-z]/.test(pw)) s += 10;
    if (/[0-9]/.test(pw)) s += 10;
    if (/[^A-Za-z0-9]/.test(pw)) s += 20;
    return Math.min(100, Math.round(s));
  }

  function updateCircle(score) {
    circleValue.innerHTML = score + "<span> / 100</span>";
    const color = score < 61 ? "#ff6b6b" : "#16a34a";
    circle.style.background =
      `conic-gradient(${color} ${score * 3.6}deg, #e5e7eb 0deg)`;
    savePwBtn.textContent = score < 61 ? "Password Change" : "Password Change Anyway";
  }

  function generateStrongPassword() {
    const U = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const L = "abcdefghijklmnopqrstuvwxyz";
    const D = "0123456789";
    const S = "!@#$%^&*()_-+=<>?/{}[]";

    let pw = [
      U[Math.random()*U.length|0],
      L[Math.random()*L.length|0],
      D[Math.random()*D.length|0],
      S[Math.random()*S.length|0]
    ];
    const all = U + L + D + S;
    const len = 12 + Math.floor(Math.random() * 5);

    while (pw.length < len)
      pw.push(all[Math.random()*all.length|0]);

    return pw.sort(() => Math.random() - 0.5).join("");
  }

  function openChangePassword(service){
    CURRENT_SERVICE = service;
    const label = service + " Password Change";
    pageTitleEl.textContent = label;
    document.title = label;

    newPw.value = "";
    rePw.value = "";
    visibleSuggestion.style.display = "none";
    visibleSuggestion.textContent = "";
    copyBtn.disabled = true;
    updateCircle(0);

    if(!LOGGED_USER_ID){
      alert("Please log in first.");
      showView("login");
      return;
    }

    showView("changePw");
  }

  document.querySelectorAll("#changePwView .toggle-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.target;
      const f = document.getElementById(id);
      f.type = f.type === "password" ? "text" : "password";
      btn.innerText = f.type === "password" ? "Show" : "Hide";
    });
  });

  newPw.addEventListener("input", () =>
    updateCircle(estimateStrength(newPw.value))
  );

  suggestBtn.addEventListener("click", () => {
    const pw = generateStrongPassword();
    newPw.value = pw;
    rePw.value = pw;
    visibleSuggestion.style.display = "block";
    visibleSuggestion.textContent = pw;
    copyBtn.disabled = false;
    updateCircle(estimateStrength(pw));
  });

  copyBtn.addEventListener("click", () => {
    navigator.clipboard.writeText(newPw.value || "");
    alert("Password copied!");
  });

  // BIG GREEN BUTTON BEHAVIOUR:
  // 1) Update DB
  // 2) Update local dashboard card
  // 3) Open Google search for "<platform> change password" in a new tab
  savePwBtn.addEventListener("click", async () => {
    if (!LOGGED_USER_ID) {
      alert("Please log in first.");
      showView("login");
      return;
    }
    if (!CURRENT_SERVICE) {
      alert("Unknown platform.");
      return;
    }
    const n1 = newPw.value;
    const n2 = rePw.value;

    if (!n1 || !n2) {
      alert("Please fill all fields.");
      return;
    }
    if (n1 !== n2) {
      alert("New passwords do not match.");
      return;
    }

    const strength = estimateStrength(n1);

    try {
      const updRes = await fetch(`${API}/api/update_platform_password`, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          user_id: LOGGED_USER_ID,
          platform: CURRENT_SERVICE,
          new_password: n1,
          strength_score: strength
        })
      });
      const updData = await updRes.json();
      if (!updRes.ok) {
        alert(updData.detail || "Error updating password.");
        return;
      }

      if (window.updateLocalAccountPassword) {
        window.updateLocalAccountPassword(CURRENT_SERVICE, n1, strength);
      }

      // open Google search in new tab
      const searchUrl =
        "https://www.google.com/search?q=" +
        encodeURIComponent(CURRENT_SERVICE + " change password");
      window.open(searchUrl, "_blank", "noopener");

      alert("Password updated successfully.");
      showView("dashboard");
    } catch (err) {
      console.error(err);
      alert("Network error while updating password.");
    }
  });

  /* WEB SAFETY PAGE */
  const WEB_STORAGE_KEY = "securityDashboardWebChecks";
  const urlInput = document.getElementById("urlInput");
  const webCheckBtn = document.getElementById("webCheckBtn");
  const webStatus = document.getElementById("webStatus");
  const webReasonsBox = document.getElementById("webReasonsBox");
  const webReasonsList = document.getElementById("webReasonsList");
  const webHistoryEmpty = document.getElementById("webHistoryEmpty");
  const webHistoryTable = document.getElementById("webHistoryTable");
  const webHistoryBody = document.getElementById("webHistoryBody");

  function loadWebHistory(){
    try{
      const raw = localStorage.getItem(WEB_STORAGE_KEY);
      if(!raw) return [];
      const p = JSON.parse(raw);
      return Array.isArray(p)?p:[];
    }catch{return [];}
  }
  function saveWebHistory(arr){
    try{localStorage.setItem(WEB_STORAGE_KEY, JSON.stringify(arr));}catch{}
  }
  function renderWebHistory(){
    const data = loadWebHistory();
    if(!data.length){
      webHistoryEmpty.style.display="block";
      webHistoryTable.style.display="none";
      return;
    }
    webHistoryEmpty.style.display="none";
    webHistoryTable.style.display="table";
    webHistoryBody.innerHTML="";
    data.slice().reverse().forEach(item=>{
      const tr=document.createElement("tr");
      const tag=item.dangerous?'<span class="tag-danger">Dangerous</span>':'<span class="tag-safe">Safe</span>';
      tr.innerHTML=`<td>${item.url}</td><td>${tag}</td><td>${item.time}</td>`;
      webHistoryBody.appendChild(tr);
    });
  }

  webCheckBtn.addEventListener("click", async () => {
    const url = urlInput.value.trim();
    if(!url){
      webStatus.textContent = "Please enter a URL.";
      webStatus.className = "status danger";
      webReasonsBox.style.display="none";
      return;
    }
    webStatus.textContent = "Checking website...";
    webStatus.className = "status";
    webReasonsBox.style.display="none";
    webCheckBtn.disabled = true;
    try{
      const res = await fetch(`${API}/api/check_website_safety`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({url})
      });
      const data = await res.json();
      if(!res.ok){
        webStatus.textContent = data.detail || "Error checking website.";
        webStatus.className = "status danger";
        return;
      }
      if(data.dangerous){
        webStatus.textContent = "⚠ This website looks risky.";
        webStatus.className = "status danger";
      }else{
        webStatus.textContent = "✅ No major issues detected for this website.";
        webStatus.className = "status safe";
      }
      webReasonsList.innerHTML="";
      (data.reasons||[]).forEach(r=>{
        const li=document.createElement("li");
        li.textContent=r;
        webReasonsList.appendChild(li);
      });
      webReasonsBox.style.display="block";
      const hist=loadWebHistory();
      hist.push({url, dangerous:!!data.dangerous, reasons:data.reasons||[], time:new Date().toLocaleString()});
      saveWebHistory(hist);
      renderWebHistory();
    }catch(err){
      console.error(err);
      webStatus.textContent="Network error. Please try again.";
      webStatus.className="status danger";
    }finally{
      webCheckBtn.disabled=false;
    }
  });

  renderWebHistory();

  /* BREACH PAGE */
  const BREACH_STORAGE_KEY = "securityDashboardBreachHistory";
  const breachEmailInput = document.getElementById("breachEmailInput");
  const breachCheckBtn = document.getElementById("breachCheckBtn");
  const breachStatusMsg = document.getElementById("breachStatusMsg");
  const breachHistoryEmpty = document.getElementById("breachHistoryEmpty");
  const breachHistoryTable = document.getElementById("breachHistoryTable");
  const breachHistoryBody = document.getElementById("breachHistoryBody");

  function loadBreachHistory(){
    try{
      const raw = localStorage.getItem(BREACH_STORAGE_KEY);
      if(!raw) return [];
      const p = JSON.parse(raw);
      return Array.isArray(p)?p:[];
    }catch{return [];}
  }
  function saveBreachHistory(arr){
    try{localStorage.setItem(BREACH_STORAGE_KEY, JSON.stringify(arr));}catch{}
  }
  function renderBreachHistory(){
    const data = loadBreachHistory();
    if(!data.length){
      breachHistoryEmpty.style.display="block";
      breachHistoryTable.style.display="none";
      return;
    }
    breachHistoryEmpty.style.display="none";
    breachHistoryTable.style.display="table";
    breachHistoryBody.innerHTML="";
    data.slice().reverse().forEach(item=>{
      const tr=document.createElement("tr");
      const tag=item.breached?'<span class="tag-breached">Breached</span>':'<span class="tag-clean">No breach</span>';
      tr.innerHTML=`
        <td>${item.email}</td>
        <td>${tag}</td>
        <td>${item.breach_count}</td>
        <td>${item.time}</td>
      `;
      breachHistoryBody.appendChild(tr);
    });
  }

  breachCheckBtn.addEventListener("click", async () => {
    const email = breachEmailInput.value.trim();
    if(!email){
      breachStatusMsg.textContent="Please enter an email address.";
      breachStatusMsg.className="status bad";
      return;
    }
    breachStatusMsg.textContent="Checking breaches...";
    breachStatusMsg.className="status";
    breachCheckBtn.disabled=true;
    try{
      const res = await fetch(`${API}/api/check_email_breach`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({email})
      });
      const data = await res.json();
      if(!res.ok){
        breachStatusMsg.textContent = data.detail || "Error checking breach status.";
        breachStatusMsg.className="status bad";
        return;
      }
      if(data.breached){
        breachStatusMsg.textContent = `⚠ This email has been found in ${data.breach_count} breach(es).`;
        breachStatusMsg.className="status bad";
      }else{
        breachStatusMsg.textContent="✅ No breaches found for this email (in this service).";
        breachStatusMsg.className="status good";
      }
      const hist = loadBreachHistory();
      hist.push({
        email,
        breached: !!data.breached,
        breach_count: data.breach_count || 0,
        time: new Date().toLocaleString()
      });
      saveBreachHistory(hist);
      renderBreachHistory();
    }catch(err){
      console.error(err);
      breachStatusMsg.textContent="Network error. Please try again.";
      breachStatusMsg.className="status bad";
    }finally{
      breachCheckBtn.disabled=false;
    }
  });

  renderBreachHistory();

  /* FILE SCAN PAGE */
  const FILE_STORAGE_KEY = "securityDashboardFileScanHistory";
  const fileInput = document.getElementById("fileInput");
  const scanBtn = document.getElementById("scanBtn");
  const fileStatusMsg = document.getElementById("fileStatusMsg");
  const threatBox = document.getElementById("threatBox");
  const threatList = document.getElementById("threatList");
  const fileHistoryEmpty = document.getElementById("fileHistoryEmpty");
  const fileHistoryTable = document.getElementById("fileHistoryTable");
  const fileHistoryBody = document.getElementById("fileHistoryBody");

  function loadFileHistory(){
    try{
      const raw = localStorage.getItem(FILE_STORAGE_KEY);
      if(!raw) return [];
      const p = JSON.parse(raw);
      return Array.isArray(p)?p:[];
    }catch{return [];}
  }
  function saveFileHistory(arr){
    try{localStorage.setItem(FILE_STORAGE_KEY, JSON.stringify(arr));}catch{}
  }
  function renderFileHistory(){
    const data = loadFileHistory();
    if(!data.length){
      fileHistoryEmpty.style.display="block";
      fileHistoryTable.style.display="none";
      return;
    }
    fileHistoryEmpty.style.display="none";
    fileHistoryTable.style.display="table";
    fileHistoryBody.innerHTML="";
    data.slice().reverse().forEach(item=>{
      const tr=document.createElement("tr");
      const tag=item.malicious?'<span class="tag-malicious">Malicious</span>':'<span class="tag-clean">Clean</span>';
      tr.innerHTML=`
        <td>${item.filename}</td>
        <td>${tag}</td>
        <td>${item.detections}</td>
        <td>${item.total_engines}</td>
        <td>${item.time}</td>
      `;
      fileHistoryBody.appendChild(tr);
    });
  }

  scanBtn.addEventListener("click", async () => {
    const file = fileInput.files[0];
    if(!file){
      fileStatusMsg.textContent="Please choose a file first.";
      fileStatusMsg.className="status bad";
      threatBox.style.display="none";
      return;
    }
    fileStatusMsg.textContent="Uploading & scanning file...";
    fileStatusMsg.className="status";
    scanBtn.disabled=true;
    threatBox.style.display="none";
    threatList.innerHTML="";
    const formData = new FormData();
    formData.append("file", file);
    try{
      const res = await fetch(`${API}/api/scan_file`, {
        method:"POST",
        body:formData
      });
      const data = await res.json();
      if(!res.ok){
        fileStatusMsg.textContent = data.detail || "Error scanning file.";
        fileStatusMsg.className="status bad";
        return;
      }
      if(data.malicious){
        fileStatusMsg.textContent=`⚠ Malicious indicators found (${data.detections} detections).`;
        fileStatusMsg.className="status bad";
      }else{
        fileStatusMsg.textContent="✅ No malicious detections reported by the engines.";
        fileStatusMsg.className="status good";
      }
      const threats = data.threat_names || [];
      if(threats.length>0){
        threats.forEach(t=>{
          const li=document.createElement("li");
          li.textContent=t;
          threatList.appendChild(li);
        });
        threatBox.style.display="block";
      }else{
        threatBox.style.display="none";
      }
      const hist = loadFileHistory();
      hist.push({
        filename:file.name,
        malicious:!!data.malicious,
        detections:data.detections||0,
        total_engines:data.total_engines||0,
        time:new Date().toLocaleString()
      });
      saveFileHistory(hist);
      renderFileHistory();
    }catch(err){
      console.error(err);
      fileStatusMsg.textContent="Network error. Please try again.";
      fileStatusMsg.className="status bad";
      threatBox.style.display="none";
    }finally{
      scanBtn.disabled=false;
    }
  });

  renderFileHistory();
</script>
</body>
</html>
